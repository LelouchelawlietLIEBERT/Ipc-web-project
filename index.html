<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Chaos Chat Uploadcare FIXED</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/@uploadcare/file-uploader@1/web/uc-file-uploader-regular.min.css">

<style>
  body { background:#fff; color:#000; font-family:system-ui,sans-serif; padding:20px; margin:0; }
  .container { max-width:700px; margin:auto; }
  input,button{width:100%;padding:14px;margin-top:10px;font-size:16px;border-radius:10px;border:1px solid #ccc;}
  button{background:#2563eb;color:white;border:none;font-weight:600;cursor:pointer;}
  .msg { padding:14px; background:#f1f1f1; border-radius:12px; margin:10px 0; word-break:break-word; }
  .me { background:#2563eb; color:white; text-align:right; }
  .meta { font-size:12px; opacity:.6; margin-bottom:6px; }
  a.fileLink { color:#2563eb; font-weight:600; display:block; margin-top:4px; word-break:break-all; }
</style>
</head>

<body>

<div id="joinPage" class="container">
  <h1>Chaos Chat ðŸ’€</h1>
  <input id="usernameInput" placeholder="Your name">
  <input id="roomInput" placeholder="Room name">
  <button id="joinBtn">Join</button>
</div>

<div id="chatPage" class="container" style="display:none;">
  <h2 id="roomTitle"></h2>
  <div id="messages"></div>

  <input id="textInput" placeholder="Messageâ€¦">
  <button id="sendBtn">Send</button>

  <!-- Uploadcare config -->
  <uc-config
    ctx-name="my-uploader"
    pubkey="08f76b7cb00ef078b17a"
    source-list="local, camera, gdrive, facebook"
    files-view-mode="grid"
    user-agent-integration="llm-js">
  </uc-config>

  <!-- REQUIRED CONTEXT PROVIDER TO RECEIVE EVENTS -->
  <uc-upload-ctx-provider ctx-name="my-uploader"></uc-upload-ctx-provider>

  <!-- Uploader UI -->
  <uc-file-uploader-regular
    ctx-name="my-uploader"
    class="uc-light uc-purple">
  </uc-file-uploader-regular>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
  import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

  import * as UC from "https://cdn.jsdelivr.net/npm/@uploadcare/file-uploader@1/web/uc-file-uploader-inline.min.js";
  UC.defineComponents(UC);

  const firebaseConfig = {
    apiKey:"AIzaSyCbUUOrC8mNhOr2hXNZzP9nE68BCddH70A",
    authDomain:"bullshit-cc1c4.firebaseapp.com",
    projectId:"bullshit-cc1c4"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  const joinPage = document.getElementById("joinPage");
  const chatPage = document.getElementById("chatPage");
  const usernameInput=document.getElementById("usernameInput");
  const roomInput=document.getElementById("roomInput");
  const joinBtn=document.getElementById("joinBtn");
  const roomTitle=document.getElementById("roomTitle");
  const messagesEl=document.getElementById("messages");
  const textInput=document.getElementById("textInput");
  const sendBtn=document.getElementById("sendBtn");

  let username=null;
  let room=null;
  let unsub=null;

  joinBtn.onclick=()=>{
    username=usernameInput.value.trim();
    room=roomInput.value.trim().toLowerCase();
    if(!username||!room) return alert("Enter username + room");
    joinPage.style.display="none";
    chatPage.style.display="block";
    roomTitle.textContent=`Room: ${room}`;
    startListener();
  };

  sendBtn.onclick=async()=>{
    const text=textInput.value.trim();
    if(!text) return;
    textInput.value="";
    await addDoc(collection(db,"rooms",room,"messages"),{
      from:username,text,time:serverTimestamp(),type:"text"
    });
  };

  // Correct Uploadcare event listener
  const ctxProvider = document.querySelector('uc-upload-ctx-provider[ctx-name="my-uploader"]');

  ctxProvider.addEventListener("file-upload-success", async (e) => {
    console.log("Upload success event:", e.detail);

    const file = e.detail; // OutputFileEntry object
    const fileUrl = file.cdnUrl;
    const name = file.originalFilename;

    await addDoc(collection(db,"rooms",room,"messages"),{
      from:username,
      fileUrl,
      filename:name,
      type: file.isImage ? "image" : "file",
      text:"",
      time:serverTimestamp()
    });
  });

  function startListener() {
    if(unsub) unsub();
    const q=query(collection(db,"rooms",room,"messages"),orderBy("time","asc"));
    unsub=onSnapshot(q,(snap)=>{
      snap.docChanges().forEach(c=>{ if(c.type==="added") renderMessage(c.doc.data()); });
      window.scrollTo(0,document.body.scrollHeight);
    });
  }

  function renderMessage(m){
    const wrap=document.createElement("div");
    wrap.classList.add("msg");
    if(m.from===username) wrap.classList.add("me");

    const meta=document.createElement("div");
    meta.classList.add("meta");
    meta.textContent=m.from;
    wrap.appendChild(meta);

    if(m.type==="file" || m.type==="image"){
      const a=document.createElement("a");
      a.href=m.fileUrl; a.target="_blank"; a.className="fileLink";
      a.textContent=`ðŸ“Ž ${m.filename}`;
      wrap.appendChild(a);
    } else {
      const t=document.createElement("div");
      t.textContent=m.text;
      wrap.appendChild(t);
    }
    messagesEl.appendChild(wrap);
  }
</script>

</body>
</html>
