<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Chaos Chat</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  body { background:#fff; color:#000; font-family:system-ui,sans-serif; margin:0; padding:0; }
  .container { padding:20px; max-width:700px; margin:auto; }
  input,button {
    width:100%; padding:14px; margin-top:10px; font-size:16px;
    border-radius:10px; border:1px solid #ccc; outline:none;
  }
  button { background:#2563eb; color:white; border:none; font-weight:600; }
  h1,h2 { margin-top:0; }
  #messages { margin-top:20px; }
  .msg {
    padding:14px; border-radius:12px; margin:8px 0; background:#f1f1f1;
    word-break:break-word;
  }
  .me { background:#2563eb; color:white; text-align:right; }
  .meta { font-size:12px; opacity:0.6; margin-bottom:4px; }
  a.fileLink { color:#2563eb; font-weight:600; word-break:break-all; display:block; margin-top:6px; }
  .expired { color:#b91c1c; font-weight:700; }
</style>
</head>
<body>

<div id="joinPage" class="container">
  <h1>Chaos Chat üíÄ</h1>
  <input id="usernameInput" placeholder="Your name">
  <input id="roomInput" placeholder="Room name">
  <button id="joinBtn">Join</button>
</div>

<div id="chatPage" class="container" style="display:none;">
  <h2 id="roomTitle"></h2>
  <div id="messages"></div>

  <input id="textInput" placeholder="Message‚Ä¶">
  <button id="sendBtn">Send</button>

  <input type="file" id="fileInput">
  <button id="uploadBtn">Send File</button>
</div>

<script type="module">
  // Firebase
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
  import {
    getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp
  } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey:"AIzaSyCbUUOrC8mNhOr2hXNZzP9nE68BCddH70A",
    authDomain:"bullshit-cc1c4.firebaseapp.com",
    projectId:"bullshit-cc1c4"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  const joinPage=document.getElementById("joinPage");
  const chatPage=document.getElementById("chatPage");
  const usernameInput=document.getElementById("usernameInput");
  const roomInput=document.getElementById("roomInput");
  const joinBtn=document.getElementById("joinBtn");
  const roomTitle=document.getElementById("roomTitle");
  const messagesEl=document.getElementById("messages");
  const textInput=document.getElementById("textInput");
  const sendBtn=document.getElementById("sendBtn");
  const fileInput=document.getElementById("fileInput");
  const uploadBtn=document.getElementById("uploadBtn");

  let username=null;
  let room=null;
  let unsub=null;

  joinBtn.onclick=()=>{
    username=usernameInput.value.trim();
    room=roomInput.value.trim().toLowerCase();
    if(!username||!room) return alert("Enter name + room");

    joinPage.style.display="none";
    chatPage.style.display="block";
    roomTitle.textContent=`Room: ${room}`;
    listen();
  };

  sendBtn.onclick=async()=>{
    const text=textInput.value.trim();
    if(!text) return;
    textInput.value="";
    await addDoc(collection(db,"rooms",room,"messages"),{
      from:username, text, time:serverTimestamp(), type:"text"
    });
  };

  uploadBtn.onclick=async()=>{
    const file=fileInput.files[0];
    if(!file) return alert("Choose a file");
    uploadBtn.disabled=true; uploadBtn.textContent="Uploading‚Ä¶";

    const form=new FormData();
    form.append("file",file);
    const res=await fetch("https://file.io", { method:"POST", body:form });
    const data=await res.json();

    if(!data.success){
      alert("Upload failed");
      uploadBtn.disabled=false; uploadBtn.textContent="Send File";
      return;
    }

    await addDoc(collection(db,"rooms",room,"messages"),{
      from:username,
      text:"",
      fileUrl:data.link,
      filename:file.name,
      type:"file",
      time:serverTimestamp()
    });

    fileInput.value="";
    uploadBtn.disabled=false; uploadBtn.textContent="Send File";
  };

  function listen(){
    if(unsub) unsub();
    const q=query(collection(db,"rooms",room,"messages"),orderBy("time","asc"));
    unsub=onSnapshot(q,(snap)=>{
      snap.docChanges().forEach(c=>{
        if(c.type==="added") render(c.doc.data());
      });
      window.scrollTo(0,document.body.scrollHeight);
    });
  }

  async function render(m){
    const el=document.createElement("div");
    el.classList.add("msg");
    if(m.from===username) el.classList.add("me");

    const meta=document.createElement("div");
    meta.classList.add("meta");
    meta.textContent=m.from;
    el.appendChild(meta);

    if(m.type==="file"){
      const a=document.createElement("a");
      a.href=m.fileUrl; a.target="_blank"; a.rel="noopener";
      a.className="fileLink";
      a.textContent=`üìé ${m.filename}`;
      
      // check expired
      try{
        const head=await fetch(m.fileUrl,{method:"HEAD"});
        if(!head.ok){
          a.textContent=`‚ùå ${m.filename} (expired/deleted)`;
          a.className="expired";
          a.href="#";
        }
      }catch{
        a.textContent=`‚ùå ${m.filename} (expired/deleted)`;
        a.className="expired";
        a.href="#";
      }

      el.appendChild(a);
    } else {
      const t=document.createElement("div");
      t.textContent=m.text;
      el.appendChild(t);
    }

    messagesEl.appendChild(el);
  }
</script>

</body>
</html>
